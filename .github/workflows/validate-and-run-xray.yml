name: Validate and (optional) Run Xray

on:
  push:
  pull_request:
  workflow_dispatch:
    inputs:
      config_path:
        description: 'Path to JSONC config inside the repo'
        required: false
        default: 'VMess-Websocket/config_client.jsonc'
      docker_image:
        description: 'Docker image to run (used on manual dispatch)'
        required: false
        default: 'xray-image:latest'

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set config path
        id: cfg
        run: |
          # prefer workflow_dispatch input if present, otherwise default
          if [ -n "${{ github.event.inputs.config_path }}" ]; then
            echo "path=${{ github.event.inputs.config_path }}" >> $GITHUB_OUTPUT
          else
            echo "path=VMess-Websocket/config_client.jsonc" >> $GITHUB_OUTPUT
          fi

      - name: Validate JSONC -> JSON (syntax check)
        run: |
          set -e
          CONFIG="${{ steps.cfg.outputs.path }}"
          if [ ! -f "$CONFIG" ]; then
            echo "Config '$CONFIG' not found in repository."
            exit 1
          fi
          python - <<'PY'
import json, re, sys, pathlib
p = pathlib.Path("""${CONFIG}""")
s = p.read_text()
s = re.sub(r'//.*?$','',s,flags=re.M)
s = re.sub(r'/\*.*?\*/','',s,flags=re.S)
try:
    json.loads(s)
    print("OK: config is valid JSON after stripping comments")
except Exception as e:
    print("Invalid JSON:", e)
    sys.exit(1)
PY

  run_xray:
    needs: validate
    runs-on: ubuntu-latest
    # Only run the container step for manual dispatch to avoid CI noise on every push
    if: ${{ github.event_name == 'workflow_dispatch' }}
    env:
      CONFIG_PATH: ${{ github.event.inputs.config_path || 'VMess-Websocket/config_client.jsonc' }}
      DOCKER_IMAGE: ${{ github.event.inputs.docker_image || 'xray-image:latest' }}
    steps:
      - uses: actions/checkout@v4

      - name: Convert JSONC to JSON
        run: |
          set -e
          CONFIG="$CONFIG_PATH"
          OUT="${CONFIG%.*}.json"
          python - <<'PY'
import re, json, pathlib, sys
p = pathlib.Path("""$CONFIG""")
s = p.read_text()
s = re.sub(r'//.*?$','',s,flags=re.M)
s = re.sub(r'/\*.*?\*/','',s,flags=re.S)
j = json.loads(s)
p_out = pathlib.Path("""$OUT""")
p_out.write_text(json.dumps(j, indent=2))
print("Wrote", p_out)
PY

      - name: Run Xray container with config
        run: |
          set -e
          CONFIG_JSON="${CONFIG_PATH%.*}.json"
          docker run --rm \
            -v "${{ github.workspace }}/${CONFIG_JSON}":/etc/xray/config.json:ro \
            "$DOCKER_IMAGE" -c /etc/xray/config.json